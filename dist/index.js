import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as a from"../../../../openai.js";import*as i from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";var d={d:(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};Error;const p=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const f=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const h=(e=>{var t={};return d.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const m=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const g=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const v=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>a.formatWorldInfo,getPromptPosition:()=>a.getPromptPosition,getPromptRole:()=>a.getPromptRole,prepareOpenAIMessages:()=>a.prepareOpenAIMessages,setOpenAIMessageExamples:()=>a.setOpenAIMessageExamples,setOpenAIMessages:()=>a.setOpenAIMessages});const _=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>i.metadata_keys});const y=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const E=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});(e=>{var t={};d.d(t,e)})({});(e=>{var t={};d.d(t,e)})({});async function b(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function w(e){return(0,f.getMaxContextSize)(e)}function S(e,t){return(0,f.parseMesExamples)(e,t)}function T(e,t,n){return(0,f.baseChatReplace)(e,t,n)}function D(e){return(0,v.getPromptRole)(e)}function A(e,{wiFormat:t}={}){return(0,v.formatWorldInfo)(e,{wiFormat:t})}function P(e){return(0,v.getPromptPosition)(e)}function C(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const a=e=>t.label?t.label(e):e,i=document.createElement("div");i.className="preset-select-container",i.style.display="flex",i.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(i,o),i.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),r=e(n);t.value=r,t.textContent=a(r),s(r)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find(e=>e.value===t.initialValue);e&&(o.value=e.value)}let l=o.value;if(o.addEventListener("change",async()=>{const e=o.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e}),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const r=a("");e.title=`Create a new ${r}`,e.setAttribute("data-i18n",`[title]Create a new ${r}`),e.addEventListener("click",async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=a(""),r=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===r||""===r.trim())return;let i=r.trim();if(Array.from(o.options).some(e=>e.value===i))return void await b("warning",`A ${a(i)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(i))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(i);"string"==typeof e&&(i=e)}const s=document.createElement("option");s.value=i,s.textContent=a(i),o.appendChild(s);const c=o.value;o.value=i,t.onSelectChange&&c!==i&&await t.onSelectChange(c,i),l=i}),i.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const r=a("");e.title=`Rename a ${r}`,e.setAttribute("data-i18n",`[title]Rename a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await b("warning",`Please select a ${a("")} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await b("warning",`This ${a(r)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const i=await n.Popup.show.input(`Rename ${a(r)}`,`Please enter a new name for "${r}":`,r);if(null===i||""===i.trim()||i===r)return;let c=i.trim();if(Array.from(o.options).some(t=>t.value===c&&t!==e))await b("warning",`A ${a(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(r,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=a(c),r===l&&(l=c),t.onSelectChange&&o.value===c&&await t.onSelectChange(r,c)}}),i.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const r=a("");e.title=`Delete a ${r}`,e.setAttribute("data-i18n",`[title]Delete a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await b("warning",`Please select a ${a("")} to delete.`);const e=o.options[o.selectedIndex],r=e.value,i=o.selectedIndex;if(s(r))return void await b("warning",`This ${a(r)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${a(r)}`,`Are you sure you want to delete "${r}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const c=r;let u,d=-1;o.options.length>1&&(d=i<o.options.length-1?i:i-1,u=o.options[d].value),o.removeChild(e),d>=0?(o.selectedIndex=d,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)}),i.appendChild(e)}return{select:o,container:i}}async function O(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:a,maxContext:i,includeNames:s,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const b=SillyTavern.getContext();let C=[],{description:O,personality:I,persona:x,scenario:N,mesExamples:R,system:M,jailbreak:k}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:b.getCharacterCardFields({chid:t});const L="textgenerationwebui"===e?b.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,F=!!L?.enabled;let j=S(R,F);let B=[];const H=function(){if("number"==typeof i)return i;if(!i)return w();if("active"===i||!n)return w();if("number"==typeof i)return i;let t;if("textgenerationwebui"===e){const e=b.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=b.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:w()}();if(H<=0)return{result:[],warnings:B};const G=b.ToolManager.isToolCallingSupported(),Y=d?.start??0,U=d?.end?d.end+1:void 0;let V=-1===Y&&0===U?[]:b.chat.slice(Y,U).filter(e=>!e.is_system||G&&Array.isArray(e.extra?.tool_invocations));V=await Promise.all(V.map(async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i}){return(0,E.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i})}(e.mes,e.is_user?E.regex_placement.USER_INPUT:E.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:V.length-t-1});return n=await async function(e,t){return await(0,g.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}}));const X=V.map(e=>h.world_info_include_names?`${e.name}: ${e.mes}`:e.mes).reverse(),{worldInfoString:W,worldInfoBefore:q,worldInfoAfter:$,worldInfoExamples:z,worldInfoDepth:J,anBefore:K,anAfter:Q}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await b.getWorldInfoPrompt(X,H,!1);for(const se of z){const le=se.content;if(0===le.length)continue;const ce=S(T(le,f.name1,f.name2),F);se.position===h.wi_anchor_position.before?j.unshift(...ce):j.push(...ce)}function Z(){let e=0;const t=[];for(let n=V.length-1;n>=0;n--){const r=V[n];if(r.extra?.token_count&&e+r.extra.token_count>H)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:s?`${r.name}: ${r.mes}`:r.mes})}C.push(...t)}if("textgenerationwebui"===e){const ue=[...j];j&&(j=function(e,t,n){return(0,m.formatInstructModeExamples)(e,t,n)}(j,f.name1,f.name2));const de=b.getPresetManager("sysprompt")?.getCompletionPresetByName(a);de&&(M=b.powerUserSettings.prefer_character_prompt&&M?M:T(de.content,f.name1,f.name2),M=F?(te=b.substituteParams(M,f.name1,f.name2,de.content),ne=L,(0,m.formatInstructModeSystemPrompt)(te,ne)):M);const pe={description:O,personality:I,persona:b.powerUserSettings.persona_description_position==p.persona_description_positions.IN_PROMPT?x:"",scenario:N,system:M,char:f.name2,user:f.name1,wiBefore:q,wiAfter:$,loreBefore:q,loreAfter:$,mesExamples:j.join(""),mesExamplesRaw:ue.join("")},fe=b.getPresetManager("context")?.getCompletionPresetByName(o);let he=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,p.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(pe,{customInstructSettings:L,customStoryString:fe?.story_string});C.push({role:"system",content:he,ignoreInstruct:!0}),Z()}else{let me=(ee=V,(0,v.setOpenAIMessages)(ee)),ge=function(e){return(0,v.setOpenAIMessageExamples)(e)}(j);async function ve(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,messages:m,messageExamples:g},_){return(0,v.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:l,quietImage:c,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,extensionPrompts:u,messages:m,messageExamples:g},_)}({name2:f.name2,charDescription:O,charPersonality:I,Scenario:N,worldInfoBefore:q,worldInfoAfter:$,extensionPrompts:b.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:M,jailbreakPromptOverride:k,personaDescription:x,messages:me,messageExamples:ge},!1);C.push(...e)}if(!n)return B.push("No preset name provided. Using default preset."),await ve(),{result:C,warnings:B};const _e=b.getPresetManager("openai")?.getCompletionPresetByName(n);if(!_e)return console.warn(`Preset not found: ${n}. Using current preset.`),B.push(`Preset not found: ${n}. Using current preset.`),ve(),{result:C,warnings:B};let ye=_e.prompt_order?.find(e=>e.character_id===f.this_chid);if(!ye&&_e.prompt_order&&_e.prompt_order.length>0&&(ye=_e.prompt_order[0]),!ye)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),B.push(`No prompt order found for preset: ${n}. Using current preset.`),ve(),{result:C,warnings:B};const Ee=N&&_e.scenario_format?b.substituteParams(_e.scenario_format):"",be=I&&_e.personality_format?b.substituteParams(_e.personality_format):"",we=b.substituteParams(_e.group_nudge_prompt),Se=_e.impersonation_prompt?b.substituteParams(_e.impersonation_prompt):"",Te=[];u&&Te.push({role:"system",content:A(q,{wiFormat:_e.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:A($,{wiFormat:_e.wi_format}),identifier:"worldInfoAfter"}),l||Te.push({role:"system",content:O,identifier:"charDescription"},{role:"system",content:be,identifier:"charPersonality"},{role:"system",content:Ee,identifier:"scenario"}),Te.push({role:"system",content:Se,identifier:"impersonate"},{role:"system",content:we,identifier:"groupNudge"});const De=b.extensionPrompts["1_memory"];De&&De.value&&Te.push({role:D(De.role),content:De.value,identifier:"summary",position:P(De.position)});const Ae=b.extensionPrompts["2_floating_prompt"];!c&&Ae&&Ae.value&&Te.push({role:D(Ae.role),content:Ae.value,identifier:"authorsNote",position:P(Ae.position)});const Pe=b.extensionPrompts["3_vectors"];Pe&&Pe.value&&Te.push({role:"system",content:Pe.value,identifier:"vectorsMemory",position:P(Pe.position)});const Ce=b.extensionPrompts["4_vectors_data_bank"];Ce&&Ce.value&&Te.push({role:D(Ce.role),content:Ce.value,identifier:"vectorsDataBank",position:P(Ce.position)});const Oe=b.extensionPrompts.chromadb;Oe&&Oe.value&&Te.push({role:"system",content:Oe.value,identifier:"smartContext",position:P(Oe.position)}),!l&&b.powerUserSettings.persona_description&&b.powerUserSettings.persona_description_position===p.persona_description_positions.IN_PROMPT&&Te.push({role:"system",content:b.powerUserSettings.persona_description,identifier:"personaDescription"}),ye.order.forEach(e=>{if(!e.enabled)return;const t=(n=e.identifier,Te.find(e=>e.identifier===n));var n;t&&t.content?C.push({role:t.role??"system",content:b.substituteParams(t.content)}):"chatHistory"===e.identifier&&Z()})}var ee,te,ne;const re=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ie in b.extensionPrompts)if(Object.hasOwn(b.extensionPrompts,Ie)){const xe=b.extensionPrompts[Ie];if(re.includes(Ie))continue;if(!b.extensionPrompts[Ie].value)continue;if(![f.extension_prompt_types.BEFORE_PROMPT,f.extension_prompt_types.IN_PROMPT].includes(xe.position))continue;if("function"==typeof xe.filter&&!await xe.filter())continue;xe.position===f.extension_prompt_types.BEFORE_PROMPT?C=[...C.slice(0,xe.depth),{role:D(xe.role)??"system",content:xe.value},...C.slice(xe.depth)]:xe.position===f.extension_prompt_types.IN_PROMPT&&(C=[...C.slice(0,C.length-xe.depth),{role:D(xe.role)??"system",content:xe.value},...C.slice(C.length-xe.depth)])}for(const Ne of J)C=[...C.slice(0,C.length-Ne.depth),{role:D(Ne.role),content:Ne.entries.join("\n")},...C.slice(C.length-Ne.depth)];if(!l){const Re=(oe=y.selected_group,ae=Number(f.this_chid),(0,y.getGroupDepthPrompts)(oe,ae));if(y.selected_group&&Array.isArray(Re)&&Re.length>0)Re.filter(e=>e.text).forEach((e,t)=>{C=[...C.slice(0,C.length-e.depth),{role:e.role,content:e.text},...C.slice(C.length-e.depth)]});else{const Me=T(b.characters[f.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),f.name1,f.name2)||"";if(Me){const ke=f.depth_prompt_depth_default,Le=b.characters[f.this_chid]?.data?.extensions?.depth_prompt?.role??f.depth_prompt_role_default;C=[...C.slice(0,C.length-ke),{role:D(Le),content:Me},...C.slice(C.length-ke)]}}}var oe,ae;let ie=-1;if(!c){const Fe={prompt:f.chat_metadata[_.metadata_keys.prompt],interval:f.chat_metadata[_.metadata_keys.interval],position:f.chat_metadata[_.metadata_keys.position],depth:f.chat_metadata[_.metadata_keys.depth],role:f.chat_metadata[_.metadata_keys.role]};if(Fe.prompt)switch(Fe.prompt=T(Fe.prompt,f.name1,f.name2),Fe.position){case f.extension_prompt_types.IN_PROMPT:C=[...C.slice(0,1),{role:"user",content:Fe.prompt},...C.slice(1)],ie=1;break;case f.extension_prompt_types.IN_CHAT:C=[...C.slice(0,C.length-Fe.depth),{role:D(Fe.role),content:Fe.prompt},...C.slice(C.length-Fe.depth)],ie=C.length-Fe.depth-1;break;case f.extension_prompt_types.BEFORE_PROMPT:C.unshift({role:"user",content:Fe.prompt}),ie=0}}return ie>=0&&(K.length>0&&(C=[...C.slice(0,ie),{role:"system",content:K.join("\n")},...C.slice(ie)],ie++),Q.length>0&&(C=[...C.slice(0,ie+1),{role:"system",content:Q.join("\n")},...C.slice(ie+1)])),{result:C,warnings:B}}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach(function(t){R(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function N(e){return N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},N(e)}function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function M(){return M=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},M.apply(this,arguments)}function k(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function L(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var F=L(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),j=L(/Edge/i),B=L(/firefox/i),H=L(/safari/i)&&!L(/chrome/i)&&!L(/android/i),G=L(/iP(ad|od|hone)/i),Y=L(/chrome/i)&&L(/android/i),U={capture:!1,passive:!1};function V(e,t,n){e.addEventListener(t,n,!F&&U)}function X(e,t,n){e.removeEventListener(t,n,!F&&U)}function W(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function q(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function $(e,t,n,r){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&W(e,t):W(e,t))||r&&e===n)return e;if(e===n)break}while(e=q(e))}return null}var z,J=/\s+/g;function K(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var r=(" "+e.className+" ").replace(J," ").replace(" "+t+" "," ");e.className=(r+(n?" "+t:"")).replace(J," ")}}function Q(e,t,n){var r=e&&e.style;if(r){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in r||-1!==t.indexOf("webkit")||(t="-webkit-"+t),r[t]=n+("string"==typeof n?"":"px")}}function Z(e,t){var n="";if("string"==typeof e)n=e;else do{var r=Q(e,"transform");r&&"none"!==r&&(n=r+" "+n)}while(!t&&(e=e.parentNode));var o=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return o&&new o(n)}function ee(e,t,n){if(e){var r=e.getElementsByTagName(t),o=0,a=r.length;if(n)for(;o<a;o++)n(r[o],o);return r}return[]}function te(){var e=document.scrollingElement;return e||document.documentElement}function ne(e,t,n,r,o){if(e.getBoundingClientRect||e===window){var a,i,s,l,c,u,d;if(e!==window&&e.parentNode&&e!==te()?(i=(a=e.getBoundingClientRect()).top,s=a.left,l=a.bottom,c=a.right,u=a.height,d=a.width):(i=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,d=window.innerWidth),(t||n)&&e!==window&&(o=o||e.parentNode,!F))do{if(o&&o.getBoundingClientRect&&("none"!==Q(o,"transform")||n&&"static"!==Q(o,"position"))){var p=o.getBoundingClientRect();i-=p.top+parseInt(Q(o,"border-top-width")),s-=p.left+parseInt(Q(o,"border-left-width")),l=i+a.height,c=s+a.width;break}}while(o=o.parentNode);if(r&&e!==window){var f=Z(o||e),h=f&&f.a,m=f&&f.d;f&&(l=(i/=m)+(u/=m),c=(s/=h)+(d/=h))}return{top:i,left:s,bottom:l,right:c,width:d,height:u}}}function re(e,t,n){for(var r=le(e,!0),o=ne(e)[t];r;){var a=ne(r)[n];if(!("top"===n||"left"===n?o>=a:o<=a))return r;if(r===te())break;r=le(r,!1)}return!1}function oe(e,t,n,r){for(var o=0,a=0,i=e.children;a<i.length;){if("none"!==i[a].style.display&&i[a]!==ft.ghost&&(r||i[a]!==ft.dragged)&&$(i[a],n.draggable,e,!1)){if(o===t)return i[a];o++}a++}return null}function ae(e,t){for(var n=e.lastElementChild;n&&(n===ft.ghost||"none"===Q(n,"display")||t&&!W(n,t));)n=n.previousElementSibling;return n||null}function ie(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===ft.clone||t&&!W(e,t)||n++;return n}function se(e){var t=0,n=0,r=te();if(e)do{var o=Z(e),a=o.a,i=o.d;t+=e.scrollLeft*a,n+=e.scrollTop*i}while(e!==r&&(e=e.parentNode));return[t,n]}function le(e,t){if(!e||!e.getBoundingClientRect)return te();var n=e,r=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var o=Q(n);if(n.clientWidth<n.scrollWidth&&("auto"==o.overflowX||"scroll"==o.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==o.overflowY||"scroll"==o.overflowY)){if(!n.getBoundingClientRect||n===document.body)return te();if(r||t)return n;r=!0}}}while(n=n.parentNode);return te()}function ce(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function ue(e,t){return function(){if(!z){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),z=setTimeout(function(){z=void 0},t)}}}function de(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function pe(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function fe(e,t,n){var r={};return Array.from(e.children).forEach(function(o){var a,i,s,l;if($(o,t.draggable,e,!1)&&!o.animated&&o!==n){var c=ne(o);r.left=Math.min(null!==(a=r.left)&&void 0!==a?a:1/0,c.left),r.top=Math.min(null!==(i=r.top)&&void 0!==i?i:1/0,c.top),r.right=Math.max(null!==(s=r.right)&&void 0!==s?s:-1/0,c.right),r.bottom=Math.max(null!==(l=r.bottom)&&void 0!==l?l:-1/0,c.bottom)}}),r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}var he="Sortable"+(new Date).getTime();function me(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach(function(e){if("none"!==Q(e,"display")&&e!==ft.ghost){t.push({target:e,rect:ne(e)});var n=x({},t[t.length-1].rect);if(e.thisAnimationDuration){var r=Z(e,!0);r&&(n.top-=r.f,n.left-=r.e)}e.fromRect=n}})},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var r in t)if(t.hasOwnProperty(r)&&t[r]===e[n][r])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var r=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var o=!1,a=0;t.forEach(function(e){var t=0,n=e.target,i=n.fromRect,s=ne(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,d=Z(n,!0);d&&(s.top-=d.f,s.left-=d.e),n.toRect=s,n.thisAnimationDuration&&ce(l,s)&&!ce(i,s)&&(u.top-s.top)/(u.left-s.left)===(i.top-s.top)/(i.left-s.left)&&(t=function(e,t,n,r){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*r.animation}(u,l,c,r.options)),ce(s,i)||(n.prevFromRect=i,n.prevToRect=s,t||(t=r.options.animation),r.animate(n,u,s,t)),t&&(o=!0,a=Math.max(a,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout(function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null},t),n.thisAnimationDuration=t)}),clearTimeout(e),o?e=setTimeout(function(){"function"==typeof n&&n()},a):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,r){if(r){Q(e,"transition",""),Q(e,"transform","");var o=Z(this.el),a=o&&o.a,i=o&&o.d,s=(t.left-n.left)/(a||1),l=(t.top-n.top)/(i||1);e.animatingX=!!s,e.animatingY=!!l,Q(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),Q(e,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),Q(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout(function(){Q(e,"transition",""),Q(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1},r)}}}}var ge=[],ve={initializeByDefault:!0},_e={mount:function(e){for(var t in ve)ve.hasOwnProperty(t)&&!(t in e)&&(e[t]=ve[t]);ge.forEach(function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),ge.push(e)},pluginEvent:function(e,t,n){var r=this;this.eventCanceled=!1,n.cancel=function(){r.eventCanceled=!0};var o=e+"Global";ge.forEach(function(r){t[r.pluginName]&&(t[r.pluginName][o]&&t[r.pluginName][o](x({sortable:t},n)),t.options[r.pluginName]&&t[r.pluginName][e]&&t[r.pluginName][e](x({sortable:t},n)))})},initializePlugins:function(e,t,n,r){for(var o in ge.forEach(function(r){var o=r.pluginName;if(e.options[o]||r.initializeByDefault){var a=new r(e,t,e.options);a.sortable=e,a.options=e.options,e[o]=a,M(n,a.defaults)}}),e.options)if(e.options.hasOwnProperty(o)){var a=this.modifyOption(e,o,e.options[o]);void 0!==a&&(e.options[o]=a)}},getEventProperties:function(e,t){var n={};return ge.forEach(function(r){"function"==typeof r.eventProperties&&M(n,r.eventProperties.call(t[r.pluginName],e))}),n},modifyOption:function(e,t,n){var r;return ge.forEach(function(o){e[o.pluginName]&&o.optionListeners&&"function"==typeof o.optionListeners[t]&&(r=o.optionListeners[t].call(e[o.pluginName],n))}),r}};function ye(e){var t=e.sortable,n=e.rootEl,r=e.name,o=e.targetEl,a=e.cloneEl,i=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,d=e.newDraggableIndex,p=e.originalEvent,f=e.putSortable,h=e.extraEventProperties;if(t=t||n&&n[he]){var m,g=t.options,v="on"+r.charAt(0).toUpperCase()+r.substr(1);!window.CustomEvent||F||j?(m=document.createEvent("Event")).initEvent(r,!0,!0):m=new CustomEvent(r,{bubbles:!0,cancelable:!0}),m.to=i||n,m.from=s||n,m.item=o||n,m.clone=a,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=d,m.originalEvent=p,m.pullMode=f?f.lastPutMode:void 0;var _=x(x({},h),_e.getEventProperties(r,t));for(var y in _)m[y]=_[y];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var Ee=["evt"],be=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.evt,o=k(n,Ee);_e.pluginEvent.bind(ft)(e,t,x({dragEl:Se,parentEl:Te,ghostEl:De,rootEl:Ae,nextEl:Pe,lastDownEl:Ce,cloneEl:Oe,cloneHidden:Ie,dragStarted:Ue,putSortable:Le,activeSortable:ft.active,originalEvent:r,oldIndex:xe,oldDraggableIndex:Re,newIndex:Ne,newDraggableIndex:Me,hideGhostForTarget:ct,unhideGhostForTarget:ut,cloneNowHidden:function(){Ie=!0},cloneNowShown:function(){Ie=!1},dispatchSortableEvent:function(e){we({sortable:t,name:e,originalEvent:r})}},o))};function we(e){ye(x({putSortable:Le,cloneEl:Oe,targetEl:Se,rootEl:Ae,oldIndex:xe,oldDraggableIndex:Re,newIndex:Ne,newDraggableIndex:Me},e))}var Se,Te,De,Ae,Pe,Ce,Oe,Ie,xe,Ne,Re,Me,ke,Le,Fe,je,Be,He,Ge,Ye,Ue,Ve,Xe,We,qe,$e=!1,ze=!1,Je=[],Ke=!1,Qe=!1,Ze=[],et=!1,tt=[],nt="undefined"!=typeof document,rt=G,ot=j||F?"cssFloat":"float",at=nt&&!Y&&!G&&"draggable"in document.createElement("div"),it=function(){if(nt){if(F)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),st=function(e,t){var n=Q(e),r=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),o=oe(e,0,t),a=oe(e,1,t),i=o&&Q(o),s=a&&Q(a),l=i&&parseInt(i.marginLeft)+parseInt(i.marginRight)+ne(o).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+ne(a).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(o&&i.float&&"none"!==i.float){var u="left"===i.float?"left":"right";return!a||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return o&&("block"===i.display||"flex"===i.display||"table"===i.display||"grid"===i.display||l>=r&&"none"===n[ot]||a&&"none"===n[ot]&&l+c>r)?"vertical":"horizontal"},lt=function(e){function t(e,n){return function(r,o,a,i){var s=r.options.group.name&&o.options.group.name&&r.options.group.name===o.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(r,o,a,i),n)(r,o,a,i);var l=(n?r:o).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},r=e.group;r&&"object"==N(r)||(r={name:r}),n.name=r.name,n.checkPull=t(r.pull,!0),n.checkPut=t(r.put),n.revertClone=r.revertClone,e.group=n},ct=function(){!it&&De&&Q(De,"display","none")},ut=function(){!it&&De&&Q(De,"display","")};nt&&!Y&&document.addEventListener("click",function(e){if(ze)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),ze=!1,!1},!0);var dt=function(e){if(Se){var t=function(e,t){var n;return Je.some(function(r){var o=r[he].options.emptyInsertThreshold;if(o&&!ae(r)){var a=ne(r),i=e>=a.left-o&&e<=a.right+o,s=t>=a.top-o&&t<=a.bottom+o;return i&&s?n=r:void 0}}),n}((e=e.touches?e.touches[0]:e).clientX,e.clientY);if(t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[he]._onDragOver(n)}}},pt=function(e){Se&&Se.parentNode[he]._isOutsideThisEl(e.target)};function ft(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=M({},t),e[he]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return st(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==ft.supportPointer&&"PointerEvent"in window&&(!H||G),emptyInsertThreshold:5};for(var r in _e.initializePlugins(this,e,n),n)!(r in t)&&(t[r]=n[r]);for(var o in lt(t),this)"_"===o.charAt(0)&&"function"==typeof this[o]&&(this[o]=this[o].bind(this));this.nativeDraggable=!t.forceFallback&&at,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?V(e,"pointerdown",this._onTapStart):(V(e,"mousedown",this._onTapStart),V(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(V(e,"dragover",this),V(e,"dragenter",this)),Je.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),M(this,me())}function ht(e,t,n,r,o,a,i,s){var l,c,u=e[he],d=u.options.onMove;return!window.CustomEvent||F||j?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=r,l.related=o||t,l.relatedRect=a||ne(t),l.willInsertAfter=s,l.originalEvent=i,e.dispatchEvent(l),d&&(c=d.call(u,l,i)),c}function mt(e){e.draggable=!1}function gt(){et=!1}function vt(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,r=0;n--;)r+=t.charCodeAt(n);return r.toString(36)}function _t(e){return setTimeout(e,0)}function yt(e){return clearTimeout(e)}ft.prototype={constructor:ft,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(Ve=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Se):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,r=this.options,o=r.preventOnFilter,a=e.type,i=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(i||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=r.filter;if(function(e){tt.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var r=t[n];r.checked&&tt.push(r)}}(n),!Se&&!(/mousedown|pointerdown/.test(a)&&0!==e.button||r.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!H||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=$(s,r.draggable,n,!1))&&s.animated||Ce===s)){if(xe=ie(s),Re=ie(s,r.draggable),"function"==typeof c){if(c.call(this,e,s,this))return we({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),be("filter",t,{evt:e}),void(o&&e.preventDefault())}else if(c&&(c=c.split(",").some(function(r){if(r=$(l,r.trim(),n,!1))return we({sortable:t,rootEl:r,name:"filter",targetEl:s,fromEl:n,toEl:n}),be("filter",t,{evt:e}),!0})))return void(o&&e.preventDefault());r.handle&&!$(l,r.handle,n,!1)||this._prepareDragStart(e,i,s)}}},_prepareDragStart:function(e,t,n){var r,o=this,a=o.el,i=o.options,s=a.ownerDocument;if(n&&!Se&&n.parentNode===a){var l=ne(n);if(Ae=a,Te=(Se=n).parentNode,Pe=Se.nextSibling,Ce=n,ke=i.group,ft.dragged=Se,Fe={target:Se,clientX:(t||e).clientX,clientY:(t||e).clientY},Ge=Fe.clientX-l.left,Ye=Fe.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Se.style["will-change"]="all",r=function(){be("delayEnded",o,{evt:e}),ft.eventCanceled?o._onDrop():(o._disableDelayedDragEvents(),!B&&o.nativeDraggable&&(Se.draggable=!0),o._triggerDragStart(e,t),we({sortable:o,name:"choose",originalEvent:e}),K(Se,i.chosenClass,!0))},i.ignore.split(",").forEach(function(e){ee(Se,e.trim(),mt)}),V(s,"dragover",dt),V(s,"mousemove",dt),V(s,"touchmove",dt),i.supportPointer?(V(s,"pointerup",o._onDrop),!this.nativeDraggable&&V(s,"pointercancel",o._onDrop)):(V(s,"mouseup",o._onDrop),V(s,"touchend",o._onDrop),V(s,"touchcancel",o._onDrop)),B&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Se.draggable=!0),be("delayStart",this,{evt:e}),!i.delay||i.delayOnTouchOnly&&!t||this.nativeDraggable&&(j||F))r();else{if(ft.eventCanceled)return void this._onDrop();i.supportPointer?(V(s,"pointerup",o._disableDelayedDrag),V(s,"pointercancel",o._disableDelayedDrag)):(V(s,"mouseup",o._disableDelayedDrag),V(s,"touchend",o._disableDelayedDrag),V(s,"touchcancel",o._disableDelayedDrag)),V(s,"mousemove",o._delayedDragTouchMoveHandler),V(s,"touchmove",o._delayedDragTouchMoveHandler),i.supportPointer&&V(s,"pointermove",o._delayedDragTouchMoveHandler),o._dragStartTimer=setTimeout(r,i.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Se&&mt(Se),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;X(e,"mouseup",this._disableDelayedDrag),X(e,"touchend",this._disableDelayedDrag),X(e,"touchcancel",this._disableDelayedDrag),X(e,"pointerup",this._disableDelayedDrag),X(e,"pointercancel",this._disableDelayedDrag),X(e,"mousemove",this._delayedDragTouchMoveHandler),X(e,"touchmove",this._delayedDragTouchMoveHandler),X(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?V(document,"pointermove",this._onTouchMove):V(document,t?"touchmove":"mousemove",this._onTouchMove):(V(Se,"dragend",this),V(Ae,"dragstart",this._onDragStart));try{document.selection?_t(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if($e=!1,Ae&&Se){be("dragStarted",this,{evt:t}),this.nativeDraggable&&V(document,"dragover",pt);var n=this.options;!e&&K(Se,n.dragClass,!1),K(Se,n.ghostClass,!0),ft.active=this,e&&this._appendGhost(),we({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(je){this._lastX=je.clientX,this._lastY=je.clientY,ct();for(var e=document.elementFromPoint(je.clientX,je.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(je.clientX,je.clientY))!==t;)t=e;if(Se.parentNode[he]._isOutsideThisEl(e),t)do{if(t[he]){if(t[he]._onDragOver({clientX:je.clientX,clientY:je.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=q(t));ut()}},_onTouchMove:function(e){if(Fe){var t=this.options,n=t.fallbackTolerance,r=t.fallbackOffset,o=e.touches?e.touches[0]:e,a=De&&Z(De,!0),i=De&&a&&a.a,s=De&&a&&a.d,l=rt&&qe&&se(qe),c=(o.clientX-Fe.clientX+r.x)/(i||1)+(l?l[0]-Ze[0]:0)/(i||1),u=(o.clientY-Fe.clientY+r.y)/(s||1)+(l?l[1]-Ze[1]:0)/(s||1);if(!ft.active&&!$e){if(n&&Math.max(Math.abs(o.clientX-this._lastX),Math.abs(o.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(De){a?(a.e+=c-(Be||0),a.f+=u-(He||0)):a={a:1,b:0,c:0,d:1,e:c,f:u};var d="matrix(".concat(a.a,",").concat(a.b,",").concat(a.c,",").concat(a.d,",").concat(a.e,",").concat(a.f,")");Q(De,"webkitTransform",d),Q(De,"mozTransform",d),Q(De,"msTransform",d),Q(De,"transform",d),Be=c,He=u,je=o}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!De){var e=this.options.fallbackOnBody?document.body:Ae,t=ne(Se,!0,rt,!0,e),n=this.options;if(rt){for(qe=e;"static"===Q(qe,"position")&&"none"===Q(qe,"transform")&&qe!==document;)qe=qe.parentNode;qe!==document.body&&qe!==document.documentElement?(qe===document&&(qe=te()),t.top+=qe.scrollTop,t.left+=qe.scrollLeft):qe=te(),Ze=se(qe)}K(De=Se.cloneNode(!0),n.ghostClass,!1),K(De,n.fallbackClass,!0),K(De,n.dragClass,!0),Q(De,"transition",""),Q(De,"transform",""),Q(De,"box-sizing","border-box"),Q(De,"margin",0),Q(De,"top",t.top),Q(De,"left",t.left),Q(De,"width",t.width),Q(De,"height",t.height),Q(De,"opacity","0.8"),Q(De,"position",rt?"absolute":"fixed"),Q(De,"zIndex","100000"),Q(De,"pointerEvents","none"),ft.ghost=De,e.appendChild(De),Q(De,"transform-origin",Ge/parseInt(De.style.width)*100+"% "+Ye/parseInt(De.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,r=e.dataTransfer,o=n.options;be("dragStart",this,{evt:e}),ft.eventCanceled?this._onDrop():(be("setupClone",this),ft.eventCanceled||((Oe=pe(Se)).removeAttribute("id"),Oe.draggable=!1,Oe.style["will-change"]="",this._hideClone(),K(Oe,this.options.chosenClass,!1),ft.clone=Oe),n.cloneId=_t(function(){be("clone",n),ft.eventCanceled||(n.options.removeCloneOnHide||Ae.insertBefore(Oe,Se),n._hideClone(),we({sortable:n,name:"clone"}))}),!t&&K(Se,o.dragClass,!0),t?(ze=!0,n._loopId=setInterval(n._emulateDragOver,50)):(X(document,"mouseup",n._onDrop),X(document,"touchend",n._onDrop),X(document,"touchcancel",n._onDrop),r&&(r.effectAllowed="move",o.setData&&o.setData.call(n,r,Se)),V(document,"drop",n),Q(Se,"transform","translateZ(0)")),$e=!0,n._dragStartId=_t(n._dragStarted.bind(n,t,e)),V(document,"selectstart",n),Ue=!0,window.getSelection().removeAllRanges(),H&&Q(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,r,o,a=this.el,i=e.target,s=this.options,l=s.group,c=ft.active,u=ke===l,d=s.sort,p=Le||c,f=this,h=!1;if(!et){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),i=$(i,s.draggable,a,!0),O("dragOver"),ft.eventCanceled)return h;if(Se.contains(e.target)||i.animated&&i.animatingX&&i.animatingY||f._ignoreWhileAnimating===i)return N(!1);if(ze=!1,c&&!s.disabled&&(u?d||(r=Te!==Ae):Le===this||(this.lastPutMode=ke.checkPull(this,c,Se,e))&&l.checkPut(this,c,Se,e))){if(o="vertical"===this._getDirection(e,i),t=ne(Se),O("dragOverValid"),ft.eventCanceled)return h;if(r)return Te=Ae,I(),this._hideClone(),O("revert"),ft.eventCanceled||(Pe?Ae.insertBefore(Se,Pe):Ae.appendChild(Se)),N(!0);var m=ae(a,s.draggable);if(!m||function(e,t,n){var r=ne(ae(n.el,n.options.draggable)),o=fe(n.el,n.options,De),a=10;return t?e.clientX>o.right+a||e.clientY>r.bottom&&e.clientX>r.left:e.clientY>o.bottom+a||e.clientX>r.right&&e.clientY>r.top}(e,o,this)&&!m.animated){if(m===Se)return N(!1);if(m&&a===e.target&&(i=m),i&&(n=ne(i)),!1!==ht(Ae,a,Se,t,i,n,e,!!i))return I(),m&&m.nextSibling?a.insertBefore(Se,m.nextSibling):a.appendChild(Se),Te=a,R(),N(!0)}else if(m&&function(e,t,n){var r=ne(oe(n.el,0,n.options,!0)),o=fe(n.el,n.options,De),a=10;return t?e.clientX<o.left-a||e.clientY<r.top&&e.clientX<r.right:e.clientY<o.top-a||e.clientY<r.bottom&&e.clientX<r.left}(e,o,this)){var g=oe(a,0,s,!0);if(g===Se)return N(!1);if(n=ne(i=g),!1!==ht(Ae,a,Se,t,i,n,e,!1))return I(),a.insertBefore(Se,g),Te=a,R(),N(!0)}else if(i.parentNode===a){n=ne(i);var v,_,y,E=Se.parentNode!==a,b=!function(e,t,n){var r=n?e.left:e.top,o=n?e.right:e.bottom,a=n?e.width:e.height,i=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return r===i||o===s||r+a/2===i+l/2}(Se.animated&&Se.toRect||t,i.animated&&i.toRect||n,o),w=o?"top":"left",S=re(i,"top","top")||re(Se,"top","top"),T=S?S.scrollTop:void 0;if(Ve!==i&&(_=n[w],Ke=!1,Qe=!b&&s.invertSwap||E),v=function(e,t,n,r,o,a,i,s){var l=r?e.clientY:e.clientX,c=r?n.height:n.width,u=r?n.top:n.left,d=r?n.bottom:n.right,p=!1;if(!i)if(s&&We<c*o){if(!Ke&&(1===Xe?l>u+c*a/2:l<d-c*a/2)&&(Ke=!0),Ke)p=!0;else if(1===Xe?l<u+We:l>d-We)return-Xe}else if(l>u+c*(1-o)/2&&l<d-c*(1-o)/2)return function(e){return ie(Se)<ie(e)?1:-1}(t);if((p=p||i)&&(l<u+c*a/2||l>d-c*a/2))return l>u+c/2?1:-1;return 0}(e,i,n,o,b?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,Qe,Ve===i),0!==v){var D=ie(Se);do{D-=v,y=Te.children[D]}while(y&&("none"===Q(y,"display")||y===De))}if(0===v||y===i)return N(!1);Ve=i,Xe=v;var A=i.nextElementSibling,P=!1,C=ht(Ae,a,Se,t,i,n,e,P=1===v);if(!1!==C)return 1!==C&&-1!==C||(P=1===C),et=!0,setTimeout(gt,30),I(),P&&!A?a.appendChild(Se):i.parentNode.insertBefore(Se,P?A:i),S&&de(S,0,T-S.scrollTop),Te=Se.parentNode,void 0===_||Qe||(We=Math.abs(_-ne(i)[w])),R(),N(!0)}if(a.contains(Se))return N(!1)}return!1}function O(s,l){be(s,f,x({evt:e,isOwner:u,axis:o?"vertical":"horizontal",revert:r,dragRect:t,targetRect:n,canSort:d,fromSortable:p,target:i,completed:N,onMove:function(n,r){return ht(Ae,a,Se,t,n,ne(n),e,r)},changed:R},l))}function I(){O("dragOverAnimationCapture"),f.captureAnimationState(),f!==p&&p.captureAnimationState()}function N(t){return O("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(f),f!==p&&(K(Se,Le?Le.options.ghostClass:c.options.ghostClass,!1),K(Se,s.ghostClass,!0)),Le!==f&&f!==ft.active?Le=f:f===ft.active&&Le&&(Le=null),p===f&&(f._ignoreWhileAnimating=i),f.animateAll(function(){O("dragOverAnimationComplete"),f._ignoreWhileAnimating=null}),f!==p&&(p.animateAll(),p._ignoreWhileAnimating=null)),(i===Se&&!Se.animated||i===a&&!i.animated)&&(Ve=null),s.dragoverBubble||e.rootEl||i===document||(Se.parentNode[he]._isOutsideThisEl(e.target),!t&&dt(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),h=!0}function R(){Ne=ie(Se),Me=ie(Se,s.draggable),we({sortable:f,name:"change",toEl:a,newIndex:Ne,newDraggableIndex:Me,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){X(document,"mousemove",this._onTouchMove),X(document,"touchmove",this._onTouchMove),X(document,"pointermove",this._onTouchMove),X(document,"dragover",dt),X(document,"mousemove",dt),X(document,"touchmove",dt)},_offUpEvents:function(){var e=this.el.ownerDocument;X(e,"mouseup",this._onDrop),X(e,"touchend",this._onDrop),X(e,"pointerup",this._onDrop),X(e,"pointercancel",this._onDrop),X(e,"touchcancel",this._onDrop),X(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;Ne=ie(Se),Me=ie(Se,n.draggable),be("drop",this,{evt:e}),Te=Se&&Se.parentNode,Ne=ie(Se),Me=ie(Se,n.draggable),ft.eventCanceled||($e=!1,Qe=!1,Ke=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),yt(this.cloneId),yt(this._dragStartId),this.nativeDraggable&&(X(document,"drop",this),X(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),H&&Q(document.body,"user-select",""),Q(Se,"transform",""),e&&(Ue&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),De&&De.parentNode&&De.parentNode.removeChild(De),(Ae===Te||Le&&"clone"!==Le.lastPutMode)&&Oe&&Oe.parentNode&&Oe.parentNode.removeChild(Oe),Se&&(this.nativeDraggable&&X(Se,"dragend",this),mt(Se),Se.style["will-change"]="",Ue&&!$e&&K(Se,Le?Le.options.ghostClass:this.options.ghostClass,!1),K(Se,this.options.chosenClass,!1),we({sortable:this,name:"unchoose",toEl:Te,newIndex:null,newDraggableIndex:null,originalEvent:e}),Ae!==Te?(Ne>=0&&(we({rootEl:Te,name:"add",toEl:Te,fromEl:Ae,originalEvent:e}),we({sortable:this,name:"remove",toEl:Te,originalEvent:e}),we({rootEl:Te,name:"sort",toEl:Te,fromEl:Ae,originalEvent:e}),we({sortable:this,name:"sort",toEl:Te,originalEvent:e})),Le&&Le.save()):Ne!==xe&&Ne>=0&&(we({sortable:this,name:"update",toEl:Te,originalEvent:e}),we({sortable:this,name:"sort",toEl:Te,originalEvent:e})),ft.active&&(null!=Ne&&-1!==Ne||(Ne=xe,Me=Re),we({sortable:this,name:"end",toEl:Te,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){be("nulling",this),Ae=Se=Te=De=Pe=Oe=Ce=Ie=Fe=je=Ue=Ne=Me=xe=Re=Ve=Xe=Le=ke=ft.dragged=ft.ghost=ft.clone=ft.active=null,tt.forEach(function(e){e.checked=!0}),tt.length=Be=He=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Se&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,r=0,o=n.length,a=this.options;r<o;r++)$(e=n[r],a.draggable,this.el,!1)&&t.push(e.getAttribute(a.dataIdAttr)||vt(e));return t},sort:function(e,t){var n={},r=this.el;this.toArray().forEach(function(e,t){var o=r.children[t];$(o,this.options.draggable,r,!1)&&(n[e]=o)},this),t&&this.captureAnimationState(),e.forEach(function(e){n[e]&&(r.removeChild(n[e]),r.appendChild(n[e]))}),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return $(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var r=_e.modifyOption(this,e,t);n[e]=void 0!==r?r:t,"group"===e&&lt(n)},destroy:function(){be("destroy",this);var e=this.el;e[he]=null,X(e,"mousedown",this._onTapStart),X(e,"touchstart",this._onTapStart),X(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(X(e,"dragover",this),X(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(e){e.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),Je.splice(Je.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!Ie){if(be("hideClone",this),ft.eventCanceled)return;Q(Oe,"display","none"),this.options.removeCloneOnHide&&Oe.parentNode&&Oe.parentNode.removeChild(Oe),Ie=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(Ie){if(be("showClone",this),ft.eventCanceled)return;Se.parentNode!=Ae||this.options.group.revertClone?Pe?Ae.insertBefore(Oe,Pe):Ae.appendChild(Oe):Ae.insertBefore(Oe,Se),this.options.group.revertClone&&this.animate(Se,Oe),Q(Oe,"display",""),Ie=!1}}else this._hideClone()}},nt&&V(document,"touchmove",function(e){(ft.active||$e)&&e.cancelable&&e.preventDefault()}),ft.utils={on:V,off:X,css:Q,find:ee,is:function(e,t){return!!$(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:ue,closest:$,toggleClass:K,clone:pe,index:ie,nextTick:_t,cancelNextTick:yt,detectDirection:st,getChild:oe,expando:he},ft.get=function(e){return e[he]},ft.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach(function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(ft.utils=x(x({},ft.utils),e.utils)),_e.mount(e)})},ft.create=function(e,t){return new ft(e,t)},ft.version="1.15.6";var Et,bt,wt,St,Tt,Dt,At=[],Pt=!1;function Ct(){At.forEach(function(e){clearInterval(e.pid)}),At=[]}function Ot(){clearInterval(Dt)}var It=ue(function(e,t,n,r){if(t.scroll){var o,a=(e.touches?e.touches[0]:e).clientX,i=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=te(),u=!1;bt!==n&&(bt=n,Ct(),Et=t.scroll,o=t.scrollFn,!0===Et&&(Et=le(n,!0)));var d=0,p=Et;do{var f=p,h=ne(f),m=h.top,g=h.bottom,v=h.left,_=h.right,y=h.width,E=h.height,b=void 0,w=void 0,S=f.scrollWidth,T=f.scrollHeight,D=Q(f),A=f.scrollLeft,P=f.scrollTop;f===c?(b=y<S&&("auto"===D.overflowX||"scroll"===D.overflowX||"visible"===D.overflowX),w=E<T&&("auto"===D.overflowY||"scroll"===D.overflowY||"visible"===D.overflowY)):(b=y<S&&("auto"===D.overflowX||"scroll"===D.overflowX),w=E<T&&("auto"===D.overflowY||"scroll"===D.overflowY));var C=b&&(Math.abs(_-a)<=s&&A+y<S)-(Math.abs(v-a)<=s&&!!A),O=w&&(Math.abs(g-i)<=s&&P+E<T)-(Math.abs(m-i)<=s&&!!P);if(!At[d])for(var I=0;I<=d;I++)At[I]||(At[I]={});At[d].vx==C&&At[d].vy==O&&At[d].el===f||(At[d].el=f,At[d].vx=C,At[d].vy=O,clearInterval(At[d].pid),0==C&&0==O||(u=!0,At[d].pid=setInterval(function(){r&&0===this.layer&&ft.active._onTouchMove(Tt);var t=At[this.layer].vy?At[this.layer].vy*l:0,n=At[this.layer].vx?At[this.layer].vx*l:0;"function"==typeof o&&"continue"!==o.call(ft.dragged.parentNode[he],n,t,e,Tt,At[this.layer].el)||de(At[this.layer].el,n,t)}.bind({layer:d}),24))),d++}while(t.bubbleScroll&&p!==c&&(p=le(p,!1)));Pt=u}},30),xt=function(e){var t=e.originalEvent,n=e.putSortable,r=e.dragEl,o=e.activeSortable,a=e.dispatchSortableEvent,i=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||o;i();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(a("spill"),this.onSpill({dragEl:r,putSortable:n}))}};function Nt(){}function Rt(){}Nt.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var r=oe(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(t,r):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:xt},M(Nt,{pluginName:"revertOnSpill"}),Rt.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:xt},M(Rt,{pluginName:"removeOnSpill"});ft.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?V(document,"dragover",this._handleAutoScroll):this.options.supportPointer?V(document,"pointermove",this._handleFallbackAutoScroll):t.touches?V(document,"touchmove",this._handleFallbackAutoScroll):V(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?X(document,"dragover",this._handleAutoScroll):(X(document,"pointermove",this._handleFallbackAutoScroll),X(document,"touchmove",this._handleFallbackAutoScroll),X(document,"mousemove",this._handleFallbackAutoScroll)),Ot(),Ct(),clearTimeout(z),z=void 0},nulling:function(){Tt=bt=Et=Pt=Dt=wt=St=null,At.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,r=(e.touches?e.touches[0]:e).clientX,o=(e.touches?e.touches[0]:e).clientY,a=document.elementFromPoint(r,o);if(Tt=e,t||this.options.forceAutoScrollFallback||j||F||H){It(e,this.options,a,t);var i=le(a,!0);!Pt||Dt&&r===wt&&o===St||(Dt&&Ot(),Dt=setInterval(function(){var a=le(document.elementFromPoint(r,o),!0);a!==i&&(i=a,Ct()),It(e,n.options,a,t)},10),wt=r,St=o)}else{if(!this.options.bubbleScroll||le(a,!0)===te())return void Ct();It(e,this.options,le(a,!1),!1)}}},M(e,{pluginName:"scroll",initializeByDefault:!0})}),ft.mount(Rt,Nt);var Mt,kt;!function(e){e.APP_READY="app_ready",e.EXTRAS_CONNECTED="extras_connected",e.MESSAGE_SWIPED="message_swiped",e.MESSAGE_SENT="message_sent",e.MESSAGE_RECEIVED="message_received",e.MESSAGE_EDITED="message_edited",e.MESSAGE_DELETED="message_deleted",e.MESSAGE_UPDATED="message_updated",e.MESSAGE_FILE_EMBEDDED="message_file_embedded",e.MORE_MESSAGES_LOADED="more_messages_loaded",e.IMPERSONATE_READY="impersonate_ready",e.CHAT_CHANGED="chat_id_changed",e.GENERATION_AFTER_COMMANDS="GENERATION_AFTER_COMMANDS",e.GENERATION_STARTED="generation_started",e.GENERATION_STOPPED="generation_stopped",e.GENERATION_ENDED="generation_ended",e.EXTENSIONS_FIRST_LOAD="extensions_first_load",e.EXTENSION_SETTINGS_LOADED="extension_settings_loaded",e.SETTINGS_LOADED="settings_loaded",e.SETTINGS_UPDATED="settings_updated",e.GROUP_UPDATED="group_updated",e.MOVABLE_PANELS_RESET="movable_panels_reset",e.SETTINGS_LOADED_BEFORE="settings_loaded_before",e.SETTINGS_LOADED_AFTER="settings_loaded_after",e.CHATCOMPLETION_SOURCE_CHANGED="chatcompletion_source_changed",e.CHATCOMPLETION_MODEL_CHANGED="chatcompletion_model_changed",e.OAI_PRESET_CHANGED_BEFORE="oai_preset_changed_before",e.OAI_PRESET_CHANGED_AFTER="oai_preset_changed_after",e.OAI_PRESET_EXPORT_READY="oai_preset_export_ready",e.OAI_PRESET_IMPORT_READY="oai_preset_import_ready",e.WORLDINFO_SETTINGS_UPDATED="worldinfo_settings_updated",e.WORLDINFO_UPDATED="worldinfo_updated",e.CHARACTER_EDITED="character_edited",e.CHARACTER_PAGE_LOADED="character_page_loaded",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE="character_group_overlay_state_change_before",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER="character_group_overlay_state_change_after",e.USER_MESSAGE_RENDERED="user_message_rendered",e.CHARACTER_MESSAGE_RENDERED="character_message_rendered",e.FORCE_SET_BACKGROUND="force_set_background",e.CHAT_DELETED="chat_deleted",e.CHAT_CREATED="chat_created",e.GROUP_CHAT_DELETED="group_chat_deleted",e.GROUP_CHAT_CREATED="group_chat_created",e.GENERATE_BEFORE_COMBINE_PROMPTS="generate_before_combine_prompts",e.GENERATE_AFTER_COMBINE_PROMPTS="generate_after_combine_prompts",e.GENERATE_AFTER_DATA="generate_after_data",e.GROUP_MEMBER_DRAFTED="group_member_drafted",e.GROUP_WRAPPER_STARTED="group_wrapper_started",e.GROUP_WRAPPER_FINISHED="group_wrapper_finished",e.WORLD_INFO_ACTIVATED="world_info_activated",e.TEXT_COMPLETION_SETTINGS_READY="text_completion_settings_ready",e.CHAT_COMPLETION_SETTINGS_READY="chat_completion_settings_ready",e.CHAT_COMPLETION_PROMPT_READY="chat_completion_prompt_ready",e.CHARACTER_FIRST_MESSAGE_SELECTED="character_first_message_selected",e.CHARACTER_DELETED="characterDeleted",e.CHARACTER_DUPLICATED="character_duplicated",e.CHARACTER_RENAMED="character_renamed",e.SMOOTH_STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_REASONING_DONE="stream_reasoning_done",e.FILE_ATTACHMENT_DELETED="file_attachment_deleted",e.WORLDINFO_FORCE_ACTIVATE="worldinfo_force_activate",e.OPEN_CHARACTER_LIBRARY="open_character_library",e.ONLINE_STATUS_CHANGED="online_status_changed",e.IMAGE_SWIPED="image_swiped",e.CONNECTION_PROFILE_LOADED="connection_profile_loaded",e.TOOL_CALLS_PERFORMED="tool_calls_performed",e.TOOL_CALLS_RENDERED="tool_calls_rendered"}(Mt||(Mt={})),function(e){e.NONE="none",e.RESPONSES="responses",e.INPUT="inputs",e.BOTH="both"}(kt||(kt={}));var Lt,Ft,jt='You are a Scene Tracker Assistant, tasked with providing clear, consistent, and structured updates to a scene tracker for a roleplay. Use the latest message, previous tracker details, and context from recent messages to accurately update the tracker. Your response must ensuring that each field is filled and complete. If specific information is not provided, make reasonable assumptions based on prior descriptions, logical inferences, or default character details.\n\n### Key Instructions:\n1. **Default Assumptions for Missing Information**:\n   - **Character Details**: If no new details are provided for a character, assume reasonable defaults (e.g., hairstyle, posture, or attire based on previous entries or context).\n   - **Outfit**: Describe the complete outfit for each character, using specific details for color, fabric, and style (e.g., “fitted black leather jacket with silver studs on the collar”). **Underwear must always be included in the outfit description.** If underwear is intentionally missing, specify this clearly in the description (e.g., "No bra", "No panties"). If the character is undressed, list the entire outfit.\n   - **StateOfDress**: Describe how put-together or disheveled the character appears, including any removed clothing. If the character is undressed, indicate where discarded items are placed.\n2. **Incremental Time Progression**:\n   - Adjust time in small increments, ideally only a few seconds per update, to reflect realistic scene progression. Avoid large jumps unless a significant time skip (e.g., sleep, travel) is explicitly stated.\n   - Format the time as "HH:MM:SS; MM/DD/YYYY (Day Name)".\n3. **Context-Appropriate Times**:\n   - Ensure that the time aligns with the setting. For example, if the scene takes place in a public venue (e.g., a mall), choose an appropriate time within standard operating hours.\n4. **Location Format**: Avoid unintended reuse of specific locations from previous examples or responses. Provide specific, relevant, and detailed locations based on the context, using the format:\n   - **Example**: “Food court, second floor near east wing entrance, Madison Square Mall, Los Angeles, CA”\n5. **Topics Format**: Ensure topics are one- or two-word keywords relevant to the scene to help trigger contextual information. Avoid long phrases.\n6. **Avoid Redundancies**: Use only details provided or logically inferred from context. Do not introduce speculative or unnecessary information.\n7. **Focus and Pause**: Treat each scene update as a standalone, complete entry. Respond with the full tracker every time, even if there are only minor updates.\n\n### Important Reminders:\n1. **Recent Messages and Current Tracker**: Before updating, always consider the recent messages to ensure all changes are accurately represented.\n\nYour primary objective is to ensure clarity, consistency, providing complete details even when specifics are not explicitly stated.',Bt={$schema:"http://json-schema.org/draft-07/schema#",title:"SceneTracker",description:"Schema for tracking roleplay scene details",type:"object",properties:{time:{type:"string",description:"Format: HH:MM:SS; MM/DD/YYYY (Day Name)"},location:{type:"string",description:"Specific scene location with increasing specificity"},weather:{type:"string",description:"Current weather conditions and temperature"},topics:{type:"object",properties:{primaryTopic:{type:"string",description:"1-2 word main topic of interaction"},emotionalTone:{type:"string",description:"Dominant emotional tone of scene"},interactionTheme:{type:"string",description:"Type of character interaction"}},required:["primaryTopic","emotionalTone","interactionTheme"]},charactersPresent:{type:"array",items:{type:"string"},description:"List of character names present in scene"},characters:{type:"array",items:{type:"object",properties:{name:{type:"string",description:"Character name"},hair:{type:"string",description:"Hairstyle and condition"},makeup:{type:"string",description:"Makeup description or 'None'"},outfit:{type:"string",description:"Complete outfit including underwear"},stateOfDress:{type:"string",description:"How put-together/disheveled character appears"},postureAndInteraction:{type:"string",description:"Character's physical positioning and interaction"}},required:["name","hair","makeup","outfit","stateOfDress","postureAndInteraction"]},description:"Array of character objects"}},required:["time","location","weather","topics","charactersPresent","characters"]};function Ht(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(c)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return Gt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Gt(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Gt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Yt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Ut(c,"_invoke",function(n,r,o){var a,s,l,c=0,u=o||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return a=t,s=0,l=e,p.n=n,i}};function f(n,r){for(s=n,l=r,t=0;!d&&c&&!o&&t<u.length;t++){var o,a=u[t],f=p.p,h=a[2];n>3?(o=h===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=n<2&&f<a[1])?(s=0,p.v=r,p.n=a[1]):f<h&&(o=n<3||a[0]>r||r>h)&&(a[4]=n,a[5]=r,p.n=h,s=0))}if(o||n>1)return i;throw d=!0,r}return function(o,u,h){if(c>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,h),s=u,l=h;(t=s<2?e:l)||!d;){a||(s?s<3?(s>1&&(p.n=-1),f(s,l)):p.n=l:p.v=l);try{if(c=2,a){if(s||(o="next"),t=a[o]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);a=e}else if((t=(d=p.n<0)?l:n.call(r,p))!==i)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:d}}}(n,o,a),!0),c}var i={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Ut(t={},r,function(){return this}),t),d=c.prototype=s.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ut(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return l.prototype=c,Ut(d,"constructor",c),Ut(c,"constructor",l),l.displayName="GeneratorFunction",Ut(c,o,"GeneratorFunction"),Ut(d),Ut(d,o,"Generator"),Ut(d,r,function(){return this}),Ut(d,"toString",function(){return"[object Generator]"}),(Yt=function(){return{w:a,m:p}})()}function Ut(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ut=function(e,t,n,r){if(t)o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var a=function(t,n){Ut(e,t,function(e){return this._invoke(t,n,e)})};a("next",0),a("throw",1),a("return",2)}},Ut(e,t,n,r)}function Vt(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Xt(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){Vt(a,r,o,i,s,"next",e)}function s(e){Vt(a,r,o,i,s,"throw",e)}i(void 0)})}}!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(Lt||(Lt={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(Ft||(Ft={}));var Wt={version:"0.1.0",formatVersion:"F_1.0",profileId:"",maxResponseToken:16e3,autoMode:kt.NONE,schemaPreset:"default",schemaPresets:{default:{name:"Default",value:Bt}},prompt:jt},qt="WTracker",$t="schemaValue",zt=SillyTavern.getContext(),Jt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],a={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),a;const i={...a,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(i.version.changed=!0,i.version.new=n,o.version=n),r&&"*"!==r&&o.formatVersion!==r&&(i.formatVersion.changed=!0,i.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||i.version.changed||i.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,i.version.changed=!0,i.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,i.formatVersion.changed=!0,i.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{let u;do{u=!1;let d=t.find(e=>e.from===c);if(d&&d.to>c)l=await d.action(l),c=d.to,l.formatVersion=d.to,u=!0;else for(const p of t)if("*"===p.from&&p.to>c&&c!==p.to){l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;break}}while(u);if(c!==o.formatVersion){i.formatVersion.changed=!0,i.formatVersion.new=c;const f=this.defaultSettings.version;f&&(l.version=f)}if(i.formatVersion.changed){for(const h of Object.keys(o))delete o[h];Object.assign(o,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return i.newSettings=o,i}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}(qt,Wt),Kt=[kt.RESPONSES,kt.BOTH],Qt=[kt.INPUT,kt.BOTH];function Zt(){return Zt=Xt(Yt().m(function e(){var t,n,r,o,a,i,s,l,c;return Yt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,zt.renderExtensionTemplateAsync("third-party/SillyTavern-WTracker","templates/settings",{});case 1:return n=e.v,(r=document.getElementById("extensions_settings"))&&r.insertAdjacentHTML("beforeend",n),e.n=2,en();case 2:return(o=document.createElement("div")).title="WTracker",o.className="mes_button mes_wtracker_button fa-solid fa-truck-moving interactable",o.tabIndex=0,(a=document.querySelector("#message_template .mes_buttons .extraMesButtons"))&&a.prepend(o),document.addEventListener("click",function(){var e=Xt(Yt().m(function e(t){var n,r,o;return Yt().w(function(e){for(;;)switch(e.n){case 0:if(!(n=t.target).classList.contains("mes_wtracker_button")){e.n=1;break}if(!(r=n.closest(".mes"))){e.n=1;break}return o=Number(r.getAttribute("mesid")),e.n=1,an(o);case 1:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()),i=Jt.getSettings(),zt.eventSource.makeFirst(Mt.CHARACTER_MESSAGE_RENDERED,function(){var e=Xt(Yt().m(function e(t){return Yt().w(function(e){for(;;)switch(e.n){case 0:if(!Kt.includes(i.autoMode)){e.n=1;break}return e.n=1,an(t);case 1:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()),zt.eventSource.makeFirst(Mt.USER_MESSAGE_RENDERED,function(){var e=Xt(Yt().m(function e(t){return Yt().w(function(e){for(;;)switch(e.n){case 0:if(!Qt.includes(i.autoMode)){e.n=1;break}return e.n=1,an(t);case 1:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()),s=document.querySelector("#extensionsMenu"),(l=document.createElement("div")).id="wtracker_wand_container",l.className="extension_container",null==s||s.appendChild(l),e.n=3,zt.renderExtensionTemplateAsync("third-party/SillyTavern-WTracker","templates/buttons");case 3:c=e.v,l.insertAdjacentHTML("beforeend",c),null==s||null===(t=s.querySelector("#wtracker_modify_schema"))||void 0===t||t.addEventListener("click",Xt(Yt().m(function e(){var t,n;return Yt().w(function(e){for(;;)switch(e.n){case 0:if((t=SillyTavern.getContext()).chatMetadata){e.n=1;break}return e.a(2);case 1:if(t.chatMetadata[qt]||(t.chatMetadata[qt]={},t.saveMetadataDebounced()),t.chatMetadata[qt][$t]){e.n=4;break}if(i.schemaPreset){e.n=3;break}return e.n=2,b("error","Chat metadata schema is not set. Please select a schema preset first in the settings.");case 2:return e.a(2);case 3:t.chatMetadata[qt][$t]=i.schemaPresets[i.schemaPreset].value,t.saveMetadataDebounced();case 4:return n=t.chatMetadata[qt][$t],e.n=5,zt.Popup.show.input("Modify WTracker Schema","Enter the new schema value in JSON format:",JSON.stringify(n,null,2),{wider:!0,large:!0,rows:16,onClose:function(e){if(e.result===Ft.AFFIRMATIVE)try{var r=JSON.parse(e.mainInput.value);t.chatMetadata[qt][$t]=r,t.saveMetadataDebounced(),b("success","Schema value updated successfully.")}catch(e){b("error","Invalid JSON format. Please check your input."),console.error("Invalid JSON:",e),t.chatMetadata[qt][$t]=n,t.saveMetadataDebounced()}},onClosing:function(e){if(e.result===Ft.AFFIRMATIVE)try{return JSON.parse(e.mainInput.value),!0}catch(e){return b("error","Invalid JSON format. Please check your input."),console.error("Invalid JSON:",e),!1}return!0}});case 5:return e.a(2)}},e)})));case 4:return e.a(2)}},e)})),Zt.apply(this,arguments)}function en(){return tn.apply(this,arguments)}function tn(){return tn=Xt(Yt().m(function e(){var t,n,r,o,a,i,s,l;return Yt().w(function(e){for(;;)switch(e.n){case 0:if(t=document.querySelector(".wtracker-settings")){e.n=1;break}return console.error("Settings container not found"),e.a(2);case 1:n=Jt.getSettings(),zt.ConnectionManagerRequestService.handleDropdown("#wtracker_connection_profile",n.profileId,function(e){var t;n.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Jt.saveSettings()}),(r=t.querySelector("#wtracker_auto_mode")).value=n.autoMode,r.addEventListener("change",function(){n.autoMode=r.value,Jt.saveSettings()}),o=t.querySelector("#wtracker_schema_preset"),a=t.querySelector("#wtracker_schema"),o.value=n.schemaPreset,a.value=JSON.stringify(n.schemaPresets[n.schemaPreset].value,null,2),C("#wtracker_schema_preset",{initialList:Object.entries(n.schemaPresets).map(function(e){var t=Ht(e,2),n=t[0];return{label:t[1].name,value:n}}),readOnlyValues:["default"],onSelectChange:function(){var e=Xt(Yt().m(function e(t,r){var o,i;return Yt().w(function(e){for(;;)switch(e.n){case 0:o=null!=r?r:"default",i=n.schemaPresets[o],n.schemaPreset=o,a.value=JSON.stringify(i.value,null,2),Jt.saveSettings();case 1:return e.a(2)}},e)}));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){n.schemaPresets[zt.uuidv4()]={name:e,value:{}}}},rename:{onAfterRename:function(e,t){n.schemaPresets[o.value].name=t}},delete:{onAfterDelete:function(e){delete n.schemaPresets[e]}}}),t.querySelector(".restore_default").addEventListener("click",function(){a.value=JSON.stringify(Bt,null,2),Jt.saveSettings()}),a.addEventListener("change",function(){try{var e=JSON.parse(a.value);n.schemaPresets[o.value].value=e}catch(e){b("error","Invalid JSON format in schema text area"),console.error("Invalid JSON:",e)}}),(i=t.querySelector("#wtracker_prompt")).value=n.prompt,i.addEventListener("change",function(){n.prompt=i.value,Jt.saveSettings()}),t.querySelector(".restore_default").addEventListener("click",function(){i.value=jt,n.prompt=jt,Jt.saveSettings()}),(s=t.querySelector("#wtracker_max_response_tokens")).value=n.maxResponseToken.toString(),s.addEventListener("input",function(){var e=parseInt(s.value,10);!isNaN(e)&&e>0?(n.maxResponseToken=e,Jt.saveSettings()):(b("error","Max response tokens must be a positive integer"),s.value=n.maxResponseToken.toString())}),(l=t.querySelector("#wtracker_reset_button"))&&l.addEventListener("click",Xt(Yt().m(function e(){return Yt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,zt.Popup.show.confirm("Reset Settings","This will reset all WTracker settings to their default values. Are you sure?");case 1:if(!e.v){e.n=2;break}return e.n=2,nn();case 2:return e.a(2)}},e)})));case 2:return e.a(2)}},e)})),tn.apply(this,arguments)}function nn(){return rn.apply(this,arguments)}function rn(){return(rn=Xt(Yt().m(function e(){var t,n;return Yt().w(function(e){for(;;)switch(e.n){case 0:if(Jt.resetSettings(),t=document.querySelector(".wtracker-settings")){e.n=1;break}return e.a(2);case 1:n=Jt.getSettings(),t.querySelector("#wtracker_auto_mode").value=n.autoMode,b("info","Settings have been reset to defaults");case 2:return e.a(2)}},e)}))).apply(this,arguments)}var on=new Set;function an(e){return sn.apply(this,arguments)}function sn(){return sn=Xt(Yt().m(function e(t){var n,r,o,a,i,s,l,c,u,d,p,h,m;return Yt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=SillyTavern.getContext().chat[t]){e.n=1;break}return b("error","Message with ID ".concat(t," not found.")),e.a(2);case 1:if((o=Jt.getSettings()).profileId){e.n=3;break}return e.n=2,b("error","Please select a connection profile first in the settings.");case 2:return e.a(2);case 3:if((a=SillyTavern.getContext()).chatMetadata[qt]||(a.chatMetadata[qt]={},a.saveMetadataDebounced()),a.chatMetadata[qt][$t]){e.n=6;break}if(o.schemaPreset){e.n=5;break}return e.n=4,b("error","Chat metadata schema is not set. Please select a schema preset first in the settings.");case 4:return e.a(2);case 5:a.chatMetadata[qt][$t]=o.schemaPresets[o.schemaPreset].value,a.saveMetadataDebounced();case 6:if(i=a.chatMetadata[qt][$t],s=null===(n=a.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find(function(e){return e.id===o.profileId}),l=null!=s&&s.api?a.CONNECT_API_MAP[s.api]:null,c=a.chat.find(function(e,n){return n===t}),c){e.n=7;break}return e.a(2);case 7:if(u=-1!==(u=f.characters.findIndex(function(e){return e.avatar===c.original_avatar}))?u:void 0,d=document.querySelector('.mes[mesid="'.concat(t,'"] .mes_wtracker_button')),e.p=8,!on.has(t)){e.n=10;break}return e.n=9,b("warning","A request for this message is already in progress. Please wait.");case 9:return e.a(2);case 10:return on.add(t),null==d||d.classList.add("spinning"),e.n=11,O(null==l?void 0:l.selected,{targetCharacterId:u,messageIndexesBetween:{end:t},presetName:null==s?void 0:s.preset,contextName:null==s?void 0:s.context,instructName:null==s?void 0:s.instruct,syspromptName:null==s?void 0:s.sysprompt,includeNames:!!y.selected_group});case 11:return p=e.v,(h=p.result).push({content:o.prompt,role:"user"}),e.n=12,a.ConnectionManagerRequestService.sendRequest(o.profileId,h,o.maxResponseToken,{},{json_schema:{name:"SceneTracker",strict:!0,value:i},temperature:.8});case 12:if((m=e.v).content&&0!==Object.keys(m.content).length){e.n=14;break}return e.n=13,b("error","No response received from WTracker.");case 13:return e.a(2);case 14:return console.log("Response from WTracker:",m),r.extra||(r.extra={}),r.extra[qt]||(r.extra[qt]={}),r.extra[qt].value=m.content,e.n=15,zt.saveChat();case 15:e.n=17;break;case 16:e.p=16,e.v;case 17:return e.p=17,on.delete(t),null==d||d.classList.remove("spinning"),e.f(17);case 18:return e.a(2)}},e,null,[[8,16,17,18]])})),sn.apply(this,arguments)}function ln(){!function(){Zt.apply(this,arguments)}()}Jt.initializeSettings().then(function(e){ln()}).catch(function(e){b("error",e),zt.Popup.show.confirm("Data migration failed. Do you want to reset the WTracker data?","Reset WTracker Data").then(function(e){e&&(Jt.resetSettings(),ln())})});